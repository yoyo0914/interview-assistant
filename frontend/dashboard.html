<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Assistant - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .welcome-card {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 2rem;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4285f4;
        }

        .stat-label {
            color: #666;
            margin-top: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4285f4;
            color: white;
        }

        .btn-primary:hover {
            background: #3367d6;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        /* æ–°å¢éƒµä»¶åˆ—è¡¨æ¨£å¼ */
        .email-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .email-section.active {
            display: block;
        }

        .email-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .email-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .email-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .email-item:hover {
            background: #f8f9fa;
        }

        .email-item.interview {
            border-left: 4px solid #4285f4;
        }

        .email-subject {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .email-meta {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .email-preview {
            font-size: 0.9rem;
            color: #888;
        }

        .email-actions {
            margin-top: 0.5rem;
            display: none;
        }

        .email-item:hover .email-actions {
            display: block;
        }

        .email-actions button {
            font-size: 0.8rem;
            padding: 4px 8px;
            margin-right: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .analyze-btn {
            background: #17a2b8;
            color: white;
        }

        .reply-btn {
            background: #28a745;
            color: white;
        }

        /* æ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-group textarea {
            min-height: 200px;
            resize: vertical;
        }

        .interview-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .interview-info h4 {
            margin-bottom: 0.5rem;
            color: #333;
        }

        .info-item {
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ğŸ“§ Interview Assistant</div>
        <div class="user-info">
            <span id="userEmail">è¼‰å…¥ä¸­...</span>
            <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>

    <div class="container">
        <div class="welcome-card">
            <div class="success-message" id="successMessage" style="display: none;">
                âœ… ç™»å…¥æˆåŠŸï¼æ­¡è¿ä½¿ç”¨ Interview Assistant
            </div>
            
            <h1>æ­¡è¿ä½¿ç”¨ Interview Assistant</h1>
            <p>è‡ªå‹•è™•ç† Gmail ä¸­çš„é¢è©¦é‚€è«‹ï¼Œä½¿ç”¨ AI ç”Ÿæˆå°ˆæ¥­å›ä¿¡</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalEmails">-</div>
                <div class="stat-label">ç¸½éƒµä»¶æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="interviewEmails">-</div>
                <div class="stat-label">é¢è©¦é‚€è«‹</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="gmailStatus">-</div>
                <div class="stat-label">Gmail ç‹€æ…‹</div>
            </div>
            <div class="stat-card sync-status-card">
                <div class="stat-number" id="syncStatus">-</div>
                <div class="stat-label" id="syncLabel">åŒæ­¥ç‹€æ…‹</div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" onclick="syncEmails()">
                åŒæ­¥ Gmail éƒµä»¶
            </button>
            <button class="btn btn-secondary" onclick="toggleEmailList()">
                æŸ¥çœ‹éƒµä»¶åˆ—è¡¨
            </button>
            <button class="btn btn-success" onclick="analyzeAllEmails()">
                AI åˆ†ææ‰€æœ‰éƒµä»¶
            </button>
            <button class="btn btn-secondary" onclick="testConnection()">
                æ¸¬è©¦é€£æ¥
            </button>
        </div>

        <!-- éƒµä»¶åˆ—è¡¨å€åŸŸ -->
        <div class="email-section" id="emailSection">
            <div class="email-header">
                <h2>ğŸ“§ éƒµä»¶åˆ—è¡¨</h2>
                <button class="btn btn-secondary" onclick="toggleEmailList()">éš±è—</button>
            </div>
            <div class="email-list" id="emailList">
                <div class="loading" style="display: block;">è¼‰å…¥éƒµä»¶ä¸­...</div>
            </div>
        </div>

        <div class="loading" id="loading">
            æ­£åœ¨è™•ç†ä¸­...
        </div>
    </div>

    <!-- é¢è©¦è³‡è¨Šæ¨¡æ…‹æ¡† -->
    <div id="interviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>é¢è©¦è³‡è¨Š</h2>
                <button class="modal-close" onclick="closeModal('interviewModal')">&times;</button>
            </div>
            <div id="interviewInfo"></div>
        </div>
    </div>

    <!-- å›ä¿¡æ¨¡æ…‹æ¡† -->
    <div id="replyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç”Ÿæˆå›ä¿¡</h2>
                <button class="modal-close" onclick="closeModal('replyModal')">&times;</button>
            </div>
            <div id="replyContent">
                <div class="form-group">
                    <label>å›ä¿¡èªèª¿</label>
                    <select id="replyTone">
                        <option value="professional">å°ˆæ¥­</option>
                        <option value="friendly">å‹å–„</option>
                        <option value="formal">æ­£å¼</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ä¸»æ—¨</label>
                    <input type="text" id="replySubject" readonly>
                </div>
                <div class="form-group">
                    <label>å›ä¿¡å…§å®¹</label>
                    <textarea id="replyBody" placeholder="é»æ“Šç”Ÿæˆå›ä¿¡æŒ‰éˆ•"></textarea>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="generateReply()">ç”Ÿæˆå›ä¿¡</button>
                    <button class="btn btn-success" onclick="sendReply()" style="display: none;" id="sendBtn">ç™¼é€å›ä¿¡</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let currentUserId = null;
        let currentEmailId = null;
        let emails = [];

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.addEventListener('load', () => {
            checkLoginStatus();
            loadUserStats();
        });

        function checkLoginStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const userId = urlParams.get('user_id');
            
            if (success === 'true' && userId) {
                currentUserId = userId;
                localStorage.setItem('userId', userId);
                localStorage.setItem('isLoggedIn', 'true');
                
                document.getElementById('successMessage').style.display = 'block';
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                const storedUserId = localStorage.getItem('userId');
                const isLoggedIn = localStorage.getItem('isLoggedIn');
                
                if (isLoggedIn === 'true' && storedUserId) {
                    currentUserId = storedUserId;
                } else {
                    window.location.href = '/static/login.html';
                    return;
                }
            }
        }

        async function loadUserStats() {
            if (!currentUserId) return;
            
            try {
                const userResponse = await fetch(`${API_BASE}/users/${currentUserId}`);
                if (userResponse.status === 404) {
                    // ç”¨æˆ¶ä¸å­˜åœ¨ï¼Œæ¸…é™¤ localStorage ä¸¦é‡å®šå‘åˆ°ç™»å…¥
                    localStorage.clear();
                    window.location.href = '/static/login.html';
                    return;
                }
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    document.getElementById('userEmail').textContent = userData.user.email;
                }

                const statusResponse = await fetch(`${API_BASE}/gmail-status/${currentUserId}`);
                if (statusResponse.status === 404) {
                    // ç”¨æˆ¶ä¸å­˜åœ¨ï¼Œæ¸…é™¤ localStorage ä¸¦é‡å®šå‘åˆ°ç™»å…¥
                    localStorage.clear();
                    window.location.href = '/static/login.html';
                    return;
                }
                
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    document.getElementById('totalEmails').textContent = statusData.stats.total_emails;
                    document.getElementById('interviewEmails').textContent = statusData.stats.interview_emails;
                    document.getElementById('gmailStatus').textContent = statusData.gmail_connected ? 'å·²é€£æ¥' : 'æœªé€£æ¥';
                    
                    // é¡¯ç¤ºåŒæ­¥ç‹€æ…‹
                    if (statusData.sync_info) {
                        const syncInfo = statusData.sync_info;
                        if (syncInfo.need_initial_sync) {
                            document.getElementById('syncStatus').textContent = 'æœªåŒæ­¥';
                            document.getElementById('syncLabel').innerHTML = 'åŒæ­¥ç‹€æ…‹<br><small>éœ€è¦é¦–æ¬¡åŒæ­¥</small>';
                        } else {
                            const lastSync = new Date(syncInfo.last_sync_at).toLocaleString('zh-TW');
                            document.getElementById('syncStatus').textContent = 'å·²åŒæ­¥';
                            document.getElementById('syncLabel').innerHTML = `åŒæ­¥ç‹€æ…‹<br><small>æœ€å¾Œ: ${lastSync}</small>`;
                        }
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆè³‡æ–™å¤±æ•—:', error);
                // å¦‚æœæ˜¯ç¶²è·¯éŒ¯èª¤ï¼Œä¹Ÿæª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç™»å…¥
                if (error.message.includes('404')) {
                    localStorage.clear();
                    window.location.href = '/static/login.html';
                }
            }
        }

        async function syncEmails() {
            if (!currentUserId) return;
            
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/sync-emails/${currentUserId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showAlert('success', data.message || `åŒæ­¥å®Œæˆï¼åŒæ­¥äº† ${data.synced_count} å°éƒµä»¶`);
                    loadUserStats();
                    if (document.getElementById('emailSection').classList.contains('active')) {
                        loadEmailList();
                    }
                } else {
                    showAlert('error', 'åŒæ­¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            } catch (error) {
                showAlert('error', 'åŒæ­¥å¤±æ•—ï¼š' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function toggleEmailList() {
            const emailSection = document.getElementById('emailSection');
            
            if (emailSection.classList.contains('active')) {
                emailSection.classList.remove('active');
            } else {
                emailSection.classList.add('active');
                await loadEmailList();
            }
        }

        async function loadEmailList() {
            if (!currentUserId) return;
            
            const emailList = document.getElementById('emailList');
            emailList.innerHTML = '<div class="loading" style="display: block;">è¼‰å…¥éƒµä»¶ä¸­...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/emails/${currentUserId}?limit=20`);
                const data = await response.json();
                
                if (data.success && data.emails.length > 0) {
                    emails = data.emails;
                    renderEmailList();
                } else {
                    emailList.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">æš«ç„¡éƒµä»¶è³‡æ–™ï¼Œè«‹å…ˆåŒæ­¥éƒµä»¶</div>';
                }
            } catch (error) {
                emailList.innerHTML = '<div style="padding: 2rem; text-align: center; color: #dc3545;">è¼‰å…¥éƒµä»¶å¤±æ•—</div>';
            }
        }

        function renderEmailList() {
            const emailList = document.getElementById('emailList');
            
            emailList.innerHTML = emails.map(email => `
                <div class="email-item ${email.is_interview_related ? 'interview' : ''}" onclick="selectEmail(${email.id})">
                    <div class="email-subject">${email.subject || '(ç„¡ä¸»æ—¨)'}</div>
                    <div class="email-meta">
                        å¾: ${email.sender} | ${new Date(email.received_at).toLocaleString('zh-TW')}
                        ${email.is_interview_related ? ' | ğŸ¯ é¢è©¦é‚€è«‹' : ''}
                    </div>
                    <div class="email-preview">${email.body_preview || ''}</div>
                    <div class="email-actions">
                        <button class="analyze-btn" onclick="event.stopPropagation(); analyzeEmail(${email.id})">AI åˆ†æ</button>
                        <button class="reply-btn" onclick="event.stopPropagation(); showReplyModal(${email.id})">ç”Ÿæˆå›ä¿¡</button>
                    </div>
                </div>
            `).join('');
        }

        function selectEmail(emailId) {
            currentEmailId = emailId;
            console.log('é¸æ“‡éƒµä»¶ ID:', emailId);
        }

        async function analyzeEmail(emailId) {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                // å…ˆåˆ†æéƒµä»¶
                const analyzeResponse = await fetch(`${API_BASE}/analyze-email/${emailId}`, {
                    method: 'POST'
                });
                const analyzeData = await analyzeResponse.json();
                
                if (analyzeData.success) {
                    // å¦‚æœæ˜¯é¢è©¦é‚€è«‹ï¼Œæå–è³‡è¨Š
                    if (analyzeData.is_interview) {
                        const extractResponse = await fetch(`${API_BASE}/extract-info/${emailId}`, {
                            method: 'POST'
                        });
                        const extractData = await extractResponse.json();
                        
                        if (extractData.success) {
                            showInterviewInfo(extractData.extracted_info);
                        }
                    }
                    
                    showAlert('success', `åˆ†æå®Œæˆ - ${analyzeData.is_interview ? 'é€™æ˜¯é¢è©¦é‚€è«‹' : 'é€™ä¸æ˜¯é¢è©¦é‚€è«‹'} (ä¿¡å¿ƒåº¦: ${analyzeData.confidence}%)`);
                    loadEmailList(); // é‡æ–°è¼‰å…¥åˆ—è¡¨ä»¥æ›´æ–°æ¨™è¨˜
                } else {
                    showAlert('error', 'åˆ†æå¤±æ•—ï¼š' + analyzeData.message);
                }
            } catch (error) {
                showAlert('error', 'åˆ†æå¤±æ•—ï¼š' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        function showInterviewInfo(info) {
            const interviewInfo = document.getElementById('interviewInfo');
            interviewInfo.innerHTML = `
                <div class="interview-info">
                    <h4>ğŸ“‹ é¢è©¦è©³æƒ…</h4>
                    <div class="info-item"><strong>å…¬å¸:</strong> ${info.company_name || 'æœªçŸ¥'}</div>
                    <div class="info-item"><strong>è·ä½:</strong> ${info.position || 'æœªçŸ¥'}</div>
                    <div class="info-item"><strong>æ—¥æœŸ:</strong> ${info.interview_date || 'æœªçŸ¥'}</div>
                    <div class="info-item"><strong>æ™‚é–“:</strong> ${info.interview_time || 'æœªçŸ¥'}</div>
                    <div class="info-item"><strong>åœ°é»:</strong> ${info.interview_location || 'æœªçŸ¥'}</div>
                    <div class="info-item"><strong>é¡å‹:</strong> ${info.interview_type || 'æœªçŸ¥'}</div>
                    <div class="info-item"><strong>é¢è©¦å®˜:</strong> ${info.interviewer_name || 'æœªçŸ¥'}</div>
                    <div class="info-item"><strong>ä¿¡å¿ƒåº¦:</strong> ${info.confidence_score || 0}%</div>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-success" onclick="closeModal('interviewModal'); showReplyModal(${currentEmailId})">ç”Ÿæˆå›ä¿¡</button>
                </div>
            `;
            document.getElementById('interviewModal').style.display = 'block';
        }

        async function showReplyModal(emailId) {
            currentEmailId = emailId;
            document.getElementById('replySubject').value = '';
            document.getElementById('replyBody').value = '';
            document.getElementById('sendBtn').style.display = 'none';
            document.getElementById('replyModal').style.display = 'block';
        }

        async function generateReply() {
            if (!currentEmailId) return;
            
            const tone = document.getElementById('replyTone').value;
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                const response = await fetch(`${API_BASE}/generate-reply/${currentEmailId}?tone=${tone}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('replySubject').value = data.subject;
                    document.getElementById('replyBody').value = data.body;
                    document.getElementById('sendBtn').style.display = 'inline-block';
                    const autoMsg = data.auto_extracted ? 'ï¼ˆå·²è‡ªå‹•åˆ†æé¢è©¦è³‡è¨Šï¼‰' : '';
                    showAlert('success', `å›ä¿¡ç”ŸæˆæˆåŠŸï¼${autoMsg}`);
                } else {
                    let errorMsg = 'ç”Ÿæˆå¤±æ•—';
                    if (data.error === 'not_interview') {
                        errorMsg = 'é€™ä¸æ˜¯é¢è©¦é‚€è«‹éƒµä»¶ï¼Œç„¡æ³•ç”Ÿæˆå›ä¿¡';
                    } else if (data.error === 'extraction_failed') {
                        errorMsg = 'ç„¡æ³•æå–é¢è©¦è³‡è¨Šï¼Œè«‹å…ˆæ‰‹å‹•åˆ†æéƒµä»¶';
                    } else if (data.message) {
                        errorMsg = data.message;
                    }
                    showAlert('error', errorMsg);
                }
            } catch (error) {
                showAlert('error', 'ç”Ÿæˆå¤±æ•—ï¼š' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function sendReply() {
            showAlert('info', 'ç™¼é€åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        async function analyzeAllEmails() {
            if (!currentUserId) return;
            
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                showAlert('info', 'é–‹å§‹æ‰¹é‡åˆ†æéƒµä»¶...');
                
                // å…ˆè¼‰å…¥æ‰€æœ‰éƒµä»¶
                const response = await fetch(`${API_BASE}/emails/${currentUserId}?limit=50`);
                const data = await response.json();
                
                if (data.success) {
                    let analyzed = 0;
                    for (let email of data.emails) {
                        try {
                            await fetch(`${API_BASE}/analyze-email/${email.id}`, { method: 'POST' });
                            analyzed++;
                        } catch (e) {
                            console.error(`åˆ†æéƒµä»¶ ${email.id} å¤±æ•—:`, e);
                        }
                    }
                    
                    showAlert('success', `æ‰¹é‡åˆ†æå®Œæˆï¼å·²åˆ†æ ${analyzed} å°éƒµä»¶`);
                    loadUserStats();
                    if (document.getElementById('emailSection').classList.contains('active')) {
                        loadEmailList();
                    }
                } else {
                    showAlert('error', 'ç„¡æ³•è¼‰å…¥éƒµä»¶åˆ—è¡¨');
                }
            } catch (error) {
                showAlert('error', 'æ‰¹é‡åˆ†æå¤±æ•—ï¼š' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/test-db`);
                const data = await response.json();
                
                if (data.success) {
                    showAlert('success', `é€£æ¥æˆåŠŸï¼ç”¨æˆ¶æ•¸: ${data.stats.users}ï¼Œéƒµä»¶æ•¸: ${data.stats.emails}`);
                } else {
                    showAlert('error', 'é€£æ¥å¤±æ•—');
                }
            } catch (error) {
                showAlert('error', 'æ¸¬è©¦å¤±æ•—ï¼š' + error.message);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.maxWidth = '400px';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('userId');
            localStorage.removeItem('isLoggedIn');
            window.location.href = '/static/login.html';
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>