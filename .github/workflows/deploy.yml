name: Deploy to Cloud Run

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: interview-assistant-465409
  SERVICE: interview-assistant
  REGION: asia-east1
  REPOSITORY: interview-assistant-repo

jobs:
  # åŠŸèƒ½æ€§æ¸¬è©¦å·¥ä½œ
  functional-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest httpx pytest-asyncio

    - name: Test basic functionality
      run: |
        echo "ğŸ§ª åŸ·è¡ŒåŠŸèƒ½æ€§æ¸¬è©¦..."
        
        # æ¸¬è©¦Pythonèªæ³•ï¼ˆåŸºæœ¬æª¢æŸ¥ï¼‰
        echo "ğŸ“ æª¢æŸ¥Pythonèªæ³•..."
        python -m py_compile backend/*.py
        
        echo "âœ… åŸºæœ¬åŠŸèƒ½æ¸¬è©¦é€šéï¼"

  # éƒ¨ç½²å·¥ä½œ
  deploy:
    runs-on: ubuntu-latest
    needs: functional-test  # ä¾è³´åŠŸèƒ½æ¸¬è©¦é€šé
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker to use gcloud
      run: gcloud auth configure-docker asia-east1-docker.pkg.dev

    - name: Build Docker image
      run: |
        docker build -t asia-east1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE:$GITHUB_SHA .

    - name: Push Docker image
      run: |
        docker push asia-east1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE:$GITHUB_SHA

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy $SERVICE \
          --image asia-east1-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$SERVICE:$GITHUB_SHA \
          --region $REGION \
          --platform managed \
          --allow-unauthenticated \
          --port 8000 \
          --memory 1Gi \
          --timeout 300 \
          --update-env-vars="GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }},GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }},GOOGLE_REDIRECT_URI=https://interview-assistant-504380981542.asia-east1.run.app/auth/callback,OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }},FRONTEND_URL=https://interview-assistant-504380981542.asia-east1.run.app"

    # ğŸ”‘ é—œéµï¼šéƒ¨ç½²å¾ŒåŠŸèƒ½é©—è­‰
    - name: Wait for deployment
      run: |
        echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
        sleep 45

    - name: Functional health check
      run: |
        echo "ğŸ¥ åŸ·è¡ŒåŠŸèƒ½æ€§å¥åº·æª¢æŸ¥..."
        
        BASE_URL="https://interview-assistant-504380981542.asia-east1.run.app"
        
        # æ¸¬è©¦1: åŸºæœ¬ç«¯é»
        echo "1ï¸âƒ£ æ¸¬è©¦åŸºæœ¬APIç«¯é»..."
        curl -f "$BASE_URL/" || (echo "âŒ åŸºæœ¬APIå¤±æ•—" && exit 1)
        
        # æ¸¬è©¦2: ç™»å…¥é é¢
        echo "2ï¸âƒ£ æ¸¬è©¦ç™»å…¥é é¢..."
        curl -f "$BASE_URL/static/login.html" || (echo "âŒ ç™»å…¥é é¢ç„¡æ³•è¨ªå•" && exit 1)
        
        # æ¸¬è©¦3: è³‡æ–™åº«æ¸¬è©¦ç«¯é»
        echo "3ï¸âƒ£ æ¸¬è©¦è³‡æ–™åº«é€£æ¥..."
        curl -f "$BASE_URL/test-db" || (echo "âŒ è³‡æ–™åº«é€£æ¥å¤±æ•—" && exit 1)
        
        # æ¸¬è©¦4: æª¢æŸ¥å›æ‡‰å…§å®¹
        echo "4ï¸âƒ£ æ¸¬è©¦APIå›æ‡‰æ ¼å¼..."
        response=$(curl -s "$BASE_URL/test-db")
        echo "APIå›æ‡‰: $response"
        
        # æ›´å¯¬é¬†çš„æª¢æŸ¥ï¼šåªè¦åŒ…å«successå°±ç®—é€šé
        if echo "$response" | grep -q '"success".*true'; then
          echo "âœ… APIå›æ‡‰æ ¼å¼æ­£ç¢º"
        else
          echo "âŒ APIå›æ‡‰æ ¼å¼ç•°å¸¸"
          exit 1
        fi
        
        echo "ğŸ‰ æ‰€æœ‰åŠŸèƒ½æ¸¬è©¦é€šéï¼éƒ¨ç½²æˆåŠŸï¼"

    # å¯é¸ï¼šå¤±æ•—æ™‚çš„é€šçŸ¥
    - name: Notify on failure
      if: failure()
      run: |
        echo "ğŸš¨ éƒ¨ç½²å¤±æ•—ï¼è«‹æª¢æŸ¥æ—¥èªŒä¸¦ä¿®å¾©å•é¡Œã€‚"